name: ERC20 Native Tests

on:
  pull_request:

jobs:
  erc20-native-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
      - uses: Swatinem/rust-cache@v2
      - name: Install llvm
        run:
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 17

      - name: Install gmplib
        run: sudo apt install -y libgmp3-dev
      - uses: actions/checkout@v3
        with:
          repository: 'lambdaclass/cairo_native'
          ref: "main"
          path: 'cairo_native'
      - name: Build cairo_native runtime
        run: |
          cd cairo_native/runtime
          cargo build --release
      - name: Run ERC20 Native Tests
        run: cd crates/blockifier && cargo test --test erc20_tests --features testing
        env:
          MLIR_SYS_170_PREFIX: /usr/lib/llvm-17
          LLVM_SYS_170_PREFIX: /usr/lib/llvm-17
          TABLEGEN_170_PREFIX: /usr/lib/llvm-17
          CAIRO_NATIVE_RUNTIME_LIBDIR: $(pwd)/cairo_native/runtime/target/release
